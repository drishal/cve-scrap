#!/usr/bin/env python
import requests
import csv
import json

# Read data from input CSV file
with open("input.csv", "r") as file:
    data = list(csv.reader(file, delimiter=","))

# Create an empty list to store output data
output_data = []

# Iterate through the CVE IDs and fetch information
for j in range(0, len(data)):
    cve = data[j][0]
    url = "https://api.osv.dev/v1/vulns/{}".format(cve)
    response = requests.get(url)
    api_data = response.json()

    # Check if the API call was successful
    if response.status_code == 200:
        id_ = api_data.get("id", "N/A")
        summary = api_data.get("summary", "N/A")
        details = api_data.get("details", "N/A")

        try:
            introduced = api_data.get("affected", [{}])[0]["ranges"][0]["events"][0]["introduced"]
        except (KeyError, IndexError):
            introduced = "N/A"

        try:
            fixed = api_data.get("affected", [{}])[0]["ranges"][0]["events"][1]["fixed"]
        except (KeyError, IndexError):
            fixed = "N/A"

            
        source = api_data.get("affected", [{}])[0]["database_specific"]["source"]

        # Append the information to the output_data list
        output_data.append([id_, summary, details, introduced, fixed, source])
    else:
        print(f"Failed to fetch data for CVE {cve}. Status code: {response.status_code}")

# Write the output_data list to an output CSV file
with open("output.csv", "w", newline="") as output_file:
    csv_writer = csv.writer(output_file)
    csv_writer.writerow(["ID", "Summary", "Details", "Introduced", "Fixed", "source"])  # Write header
    csv_writer.writerows(output_data)  # Write the fetched information
